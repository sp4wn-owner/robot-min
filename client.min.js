let username,password;const allowAllUsers=!0,allowedUsers=["user1","user2"],allowPrivateToggle=!0;let isPrivate=!1;const handleSecretCodeAuth=!1,secretCode="",allowVisibilityToggle=!0;let isVisible=!1;const startButton=document.getElementById("startButton"),localVideo=document.getElementById("localVideo"),snackbar=document.getElementById("snackbar"),loginButton=document.getElementById("login-button"),modalLogin=document.getElementById("modal-login"),closeLoginSpan=document.getElementById("close-login-modal"),usernameInput=document.getElementById("username-input"),passwordInput=document.getElementById("password-input"),confirmLoginButton=document.getElementById("confirm-login-button"),simServerInput=document.getElementById("sim-server-input");let localStream,peerConnection,connectedUser,configuration,connectionTimeout,simConnectionTimeout,profilePicture,mylocation,description,tokenrate,signalingSocket,simServer,simURL,inputChannel;const botdevicetype="vr";let responseHandlers={},emitter,isConnectedToSignalingServer=!1,isConnectedToSimServer=!1,isUserAuthenticated=!1;const maxReconnectAttempts=5;let reconnectAttempts=0,simReconnectAttempts=0;const reconnectDelay=2e3,wsUrl="https://sp4wn-signaling-server.onrender.com";let isAudioEnabled=!0;function getCookie(e){let n=("; "+document.cookie).split("; "+e+"=");if(2==n.length)return n.pop().split(";").shift()}function openLoginModal(){modalLogin.style.display="block"}function login(){if(console.log("Logging in..."),username=usernameInput.value.toLowerCase(),password=passwordInput.value,!username||!password){showSnackbar("Please enter username and password");return}connectToSignalingServer()}async function connectToSignalingServer(){return isConnectedToSignalingServer?(console.log("Already connected to the signaling server."),!0):new Promise((e,n)=>{signalingSocket=new WebSocket(wsUrl),connectionTimeout=setTimeout(()=>{try{signalingSocket.close()}catch(e){console.log(e)}n(Error("Connection timed out"))},1e4),signalingSocket.onopen=()=>{console.log("Authenticating user..."),isConnectedToSignalingServer=!0,reconnectAttempts=0,clearTimeout(connectionTimeout),send({type:"robot",username:username,password:password,device:"vr"})},signalingSocket.onmessage=async n=>{let t=JSON.parse(n.data);emitter.emit(t.type,t),responseHandlers[t.type]?(responseHandlers[t.type](t),delete responseHandlers[t.type]):await handleSignalingData(t,e)},signalingSocket.onclose=()=>{clearTimeout(connectionTimeout),isConnectedToSignalingServer=!1,console.log("Disconnected from signaling server"),isUserAuthenticated&&handleReconnect()},signalingSocket.onerror=e=>{clearTimeout(connectionTimeout),isConnectedToSignalingServer=!1,console.error("WebSocket error:",e),n(e)}})}function send(e){signalingSocket.send(JSON.stringify(e))}function handleReconnect(){if(reconnectAttempts<5){reconnectAttempts++;let e=2e3*reconnectAttempts;console.log(`Reconnecting in ${e/1e3} seconds... (Attempt ${reconnectAttempts})`),setTimeout(connectToSignalingServer,e)}else console.log("Max reconnect attempts reached. Please refresh the page.")}async function handleSignalingData(e,n){switch(e.type){case"authenticated":handleLogin(e.success,e.errormessage,e.pic,e.tokenrate,e.location,e.description,e.priv,e.visibility,e.configuration),e.success&&n(!0);break;case"offer":if(peerConnection){await peerConnection.setRemoteDescription(new RTCSessionDescription(e.offer));let t=await peerConnection.createAnswer();await peerConnection.setLocalDescription(t),signalingSocket.send(JSON.stringify({type:"answer",answer:t}))}else console.log("no answer peer connection");break;case"answer":if(peerConnection)try{await peerConnection.setRemoteDescription(new RTCSessionDescription(e.answer))}catch(o){console.error("Error when setting remote description: ",o)}else console.log("no answer peer connection");break;case"candidate":if(e.candidate)try{let r=new RTCIceCandidate(e.candidate);await peerConnection.addIceCandidate(r),console.log("ICE candidate added successfully.")}catch(i){console.error("Error adding ICE candidate:",i)}else console.warn("No ICE candidate in the message.");break;case"watch":watchStream(e.name,e.pw);break;case"endStream":endStream()}}document.addEventListener("DOMContentLoaded",()=>{let e=getCookie("simserverurl");e&&(simServerInput.value=decodeURIComponent(e)),emitter=new EventEmitter3}),closeLoginSpan.onclick=function(){modalLogin.style.display="none"},passwordInput.addEventListener("keydown",function(e){"Enter"===e.key&&login()});let loginRetryTimeout;function handleLogin(e,n,t,o,r,i,s,c,a){e||("User is already logged in"===n?loginRetryTimeout=setTimeout(()=>{send({type:"robot",username:username,password:password,device:"vr"}),showSnackbar("Retrying login in 10 seconds. You'll need to disconnect any active sessions to login."),console.log("Retrying login in 10 seconds. You'll need to disconnect any active sessions to login."),isConnectedToSignalingServer=!1,connectToSignalingServer()},5e3):(console.log(n),signalingSocket.close())),e&&(clearTimeout(loginRetryTimeout),isUserAuthenticated=!0,console.log("Successfully logged in"),loginButton.style.display="none",modalLogin.style.display="none",configuration=a,profilePicture=t||console.log("No picture"),tokenrate=o||(console.log("No token rate"),0),mylocation=r||console.log("No location"),description=i||console.log("No description"),"boolean"!=typeof s?console.log("No private status"):isPrivate=s,"boolean"!=typeof c?console.log("No visibility status"):isVisible=c)}async function watchStream(e,n){if(isPrivate){if(n)try{let t=await verifyPassword(n);if(t){if(tokenrate>0){let o=await checkTokenBalance(e);o?iceAndOffer(e):console.log("User attempted to connect with valid password, but their balance was too low")}else iceAndOffer(e)}else console.log("Password not authenticated")}catch(r){console.log("Error verifying password:",r)}else{console.log("No bot password detected");return}}else iceAndOffer(e)}function checkTokenBalance(e){return new Promise((n,t)=>{checkUserTokenBalance({type:"checkTokenBalance",username:e,tokenrate:tokenrate}).then(e=>{e.success?n(!0):t(Error("Balance check failed"))}).catch(e=>{t(e)})})}function checkUserTokenBalance(e){return new Promise((n,t)=>{signalingSocket.send(JSON.stringify(e),e=>{e&&t(e)}),emitter.once("balanceChecked",e=>{try{n(e)}catch(o){t(o)}})})}function verifyPassword(e){return new Promise((n,t)=>{sendPW({type:"checkPassword",username:username,password:e}).then(e=>{e.success?n(!0):t(Error("Password verification failed"))}).catch(e=>{t(e)})})}async function authenticateCode(e){try{if(""===e)return{success:!0};return{success:!1}}catch(n){return console.log("Failed to authenticate password:",n),{success:!1}}}function sendPW(e){return new Promise((n,t)=>{responseHandlers.authbotpw=e=>{try{n(e)}catch(o){t(o)}},signalingSocket.send(JSON.stringify(e),e=>{if(e){t(e);return}})})}function iceAndOffer(e){if(peerConnection){let n=peerConnection.iceConnectionState;if("connected"!==n&&"completed"!==n)try{connectedUser=e,createDataChannel("input"),console.log("Data channel created. Now creating offer..."),createOffer(),console.log("Offer created and sent")}catch(t){console.error("Error during watchStream:",t)}}else console.log("Peer connection is not initialized.")}function createOffer(){return new Promise((e,n)=>{peerConnection.createOffer().then(e=>peerConnection.setLocalDescription(e).then(()=>e)).then(n=>{send({type:"offer",offer:n,username:username,host:connectedUser}),e()}).catch(e=>n(e))})}async function connectToSimServer(){return console.log("Connecting to simulation server..."),new Promise((e,n)=>{simServer=new WebSocket(simURL),simConnectionTimeout=setTimeout(()=>{try{simServer.close()}catch(e){console.log(e)}n(Error("Connection timed out"))},3e3),simServer.onopen=()=>{clearTimeout(simConnectionTimeout),simReconnectAttempts=0,isConnectedToSimServer=!0,console.log("Connected to simulation server",simServer),e()},simServer.onmessage=async e=>{let n=JSON.parse(e.data);console.log("Received message from simulation server:",n)},simServer.onclose=()=>{clearTimeout(simConnectionTimeout),isConnectedToSimServer=!1,console.log("Disconnected from simulation server"),showSnackbar("Disconnected from simulation server")},simServer.onerror=e=>{clearTimeout(simConnectionTimeout),isConnectedToSimServer=!1,console.error("WebSocket error:",e),n(e)}})}function sendToSimServer(e){simServer.send(e)}function handleSimReconnect(){if(simReconnectAttempts<5){simReconnectAttempts++;let e=2e3*simReconnectAttempts;console.log(`Reconnecting in ${e/1e3} seconds... (Attempt ${simReconnectAttempts})`),setTimeout(connectToSimServer,e)}else console.log("Max reconnect attempts reached. Please refresh the page.")}async function start(){if(signalingSocket&&signalingSocket.readyState===WebSocket.OPEN)(simURL=simServerInput.value)&&(document.cookie=`simserver=${encodeURIComponent(simURL)}; max-age=31536000; path=/`,isConnectedToSimServer||await connectToSimServer());else{showSnackbar("You must be logged in to start streaming.");return}startButton.textContent="End",startButton.onclick=endStream;try{localStream=await navigator.mediaDevices.getUserMedia({video:!0,audio:isAudioEnabled}),localVideo.srcObject=localStream,createPeerConnection(),pushLive()}catch(e){showSnackbar("Error accessing media devices.",e)}}async function createPeerConnection(){peerConnection=new RTCPeerConnection(configuration),localStream.getTracks().forEach(e=>{peerConnection.addTrack(e,localStream)}),peerConnection.onicecandidate=e=>{e.candidate&&send({type:"candidate",othername:connectedUser,candidate:e.candidate})},peerConnection.ontrack=e=>{localVideo.srcObject=e.streams[0]},peerConnection.oniceconnectionstatechange=()=>{if(!peerConnection){console.error("Peer connection is not initialized.");return}switch(peerConnection.iceConnectionState){case"new":console.log("ICE Connection State is new.");break;case"checking":console.log("ICE Connection is checking.");break;case"connected":console.log("ICE Connection has been established."),send({type:"updatelive",username:username});break;case"completed":console.log("ICE Connection is completed.");break;case"failed":console.log("peer connection failed");case"disconnected":console.log("peer disconnected"),pushLive()}}}async function pushLive(){try{send({type:"storeimg",image:profilePicture,username:username,tokenrate:tokenrate,location:mylocation,description:description,botdevicetype:"vr",private:isPrivate,visibility:isVisible})}catch(e){console.log("Failed to process and send live details to server",e)}}async function createDataChannel(e){let n;try{(n=peerConnection.createDataChannel(e))&&console.log(`${e} channel created successfully.`)}catch(t){console.error(`Failed to create ${e} channel:`,t);return}"input"===e&&handleInputChannel(inputChannel=n)}function handleInputChannel(e){e.onopen=()=>{console.log("Input channel connected to peer"),e.send("Robot input channel initialized")},e.onmessage=e=>{let n;try{n=JSON.parse(e.data)}catch(t){console.error("Error parsing command:",t);return}n.type="tracking",isConnectedToSimServer?(sendToSimServer(JSON.stringify(n)),console.log("sent to sim server:",n)):console.log("Command received:",n)},e.onclose=()=>{console.log("Input channel has been closed")}}async function stopAutoRedeem(){try{let e=await fetch(`${wsUrl}/stopAutoRedeem`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userUsername:connectedUser,hostUsername:username})}),n=await e.json();if(n.success)return console.log(n.message),!0;return console.log("Failed to stop auto-redemption:",n.error),!1}catch(t){return console.log("Error stopping auto-redemption:",t),!1}}function endStream(){send({type:"updatelive",username:username}),startButton.textContent="Start",startButton.onclick=start;try{stopAutoRedeem()}catch(e){console.log(e)}if(isConnectedToSimServer)try{simServer.close(),isConnectedToSimServer=!1}catch(n){console.log(n)}peerConnection&&(peerConnection.close(),peerConnection=null),localStream&&(localStream.getTracks().forEach(e=>{e.stop()}),localStream=null),localVideo.srcObject&&(localVideo.srcObject.getTracks().forEach(e=>e.stop()),localVideo.srcObject=null)}function showSnackbar(e){try{snackbar.textContent=e,snackbar.className="snackbar show",setTimeout(function(){snackbar.className=snackbar.className.replace("show","")},5e3)}catch(n){console.error("Error showing snackbar:",n)}}function toggleAudio(){isAudioEnabled=!isAudioEnabled;let e=document.getElementById("toggleAudio");isAudioEnabled?(e.classList.remove("fa-microphone-slash"),e.classList.add("fa-microphone")):(e.classList.remove("fa-microphone"),e.classList.add("fa-microphone-slash")),localStream&&localStream.getAudioTracks().forEach(e=>{e.enabled=isAudioEnabled})}startButton.onclick=start,confirmLoginButton.onclick=login,loginButton.onclick=openLoginModal,function(e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).EventEmitter3=e()}(function(){return(function e(n,t,o){function r(s,c){if(!t[s]){if(!n[s]){var a="function"==typeof require&&require;if(!c&&a)return a(s,!0);if(i)return i(s,!0);var l=Error("Cannot find module '"+s+"'");throw l.code="MODULE_NOT_FOUND",l}var d=t[s]={exports:{}};n[s][0].call(d.exports,function(e){return r(n[s][1][e]||e)},d,d.exports,e,n,t,o)}return t[s].exports}for(var i="function"==typeof require&&require,s=0;s<o.length;s++)r(o[s]);return r})({1:[function(e,n,t){"use strict";var o=Object.prototype.hasOwnProperty,r="~";function i(){}function s(e,n,t){this.fn=e,this.context=n,this.once=t||!1}function c(e,n,t,o,i){if("function"!=typeof t)throw TypeError("The listener must be a function");var c=new s(t,o||e,i),a=r?r+n:n;return e._events[a]?e._events[a].fn?e._events[a]=[e._events[a],c]:e._events[a].push(c):(e._events[a]=c,e._eventsCount++),e}function a(e,n){0==--e._eventsCount?e._events=new i:delete e._events[n]}function l(){this._events=new i,this._eventsCount=0}Object.create&&(i.prototype=Object.create(null),(new i).__proto__||(r=!1)),l.prototype.eventNames=function(){var e,n,t=[];if(0===this._eventsCount)return t;for(n in e=this._events)o.call(e,n)&&t.push(r?n.slice(1):n);return Object.getOwnPropertySymbols?t.concat(Object.getOwnPropertySymbols(e)):t},l.prototype.listeners=function(e){var n=r?r+e:e,t=this._events[n];if(!t)return[];if(t.fn)return[t.fn];for(var o=0,i=t.length,s=Array(i);o<i;o++)s[o]=t[o].fn;return s},l.prototype.listenerCount=function(e){var n=r?r+e:e,t=this._events[n];return t?t.fn?1:t.length:0},l.prototype.emit=function(e,n,t,o,i,s){var c=r?r+e:e;if(!this._events[c])return!1;var a,l=this._events[c],d=arguments.length;if(l.fn){switch(l.once&&this.removeListener(e,l.fn,void 0,!0),d){case 1:return l.fn.call(l.context),!0;case 2:return l.fn.call(l.context,n),!0;case 3:return l.fn.call(l.context,n,t),!0;case 4:return l.fn.call(l.context,n,t,o),!0;case 5:return l.fn.call(l.context,n,t,o,i),!0;case 6:return l.fn.call(l.context,n,t,o,i,s),!0}for(g=1,a=Array(d-1);g<d;g++)a[g-1]=arguments[g];l.fn.apply(l.context,a)}else for(var u,p=l.length,g=0;g<p;g++)switch(l[g].once&&this.removeListener(e,l[g].fn,void 0,!0),d){case 1:l[g].fn.call(l[g].context);break;case 2:l[g].fn.call(l[g].context,n);break;case 3:l[g].fn.call(l[g].context,n,t);break;case 4:l[g].fn.call(l[g].context,n,t,o);break;default:if(!a)for(u=1,a=Array(d-1);u<d;u++)a[u-1]=arguments[u];l[g].fn.apply(l[g].context,a)}return!0},l.prototype.on=function(e,n,t){return c(this,e,n,t,!1)},l.prototype.once=function(e,n,t){return c(this,e,n,t,!0)},l.prototype.removeListener=function(e,n,t,o){var i=r?r+e:e;if(!this._events[i])return this;if(!n)return a(this,i),this;var s=this._events[i];if(s.fn)s.fn!==n||o&&!s.once||t&&s.context!==t||a(this,i);else{for(var c=0,l=[],d=s.length;c<d;c++)(s[c].fn!==n||o&&!s[c].once||t&&s[c].context!==t)&&l.push(s[c]);l.length?this._events[i]=1===l.length?l[0]:l:a(this,i)}return this},l.prototype.removeAllListeners=function(e){var n;return e?(n=r?r+e:e,this._events[n]&&a(this,n)):(this._events=new i,this._eventsCount=0),this},l.prototype.off=l.prototype.removeListener,l.prototype.addListener=l.prototype.on,l.prefixed=r,l.EventEmitter=l,void 0!==n&&(n.exports=l)},{}]},{},[1])(1)});